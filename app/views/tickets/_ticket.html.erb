<% first_file = ticket.original_files.first %>
<% is_pdf     = first_file&.content_type == "application/pdf" %>

<%# â”€â”€ Status-driven background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ %>
<% bg_class = case ticket.status
              when "auto_verified"               then "bg-emerald-50"
              when "needs_review", "manual_required" then "bg-amber-50"
              when "error"                       then "bg-red-50"
              else ""
              end %>

<div id="<%= dom_id(ticket) %>"
     class="flex items-start gap-4 px-5 py-4 border-b border-slate-100 last:border-0
            hover:brightness-95 transition-all <%= bg_class %>">

  <%# â”€â”€ File icon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ %>
  <div class="w-9 h-9 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5
              <%= is_pdf ? 'bg-red-100' : 'bg-indigo-100' %>">
    <% if is_pdf %>
      <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
      </svg>
    <% else %>
      <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
    <% end %>
  </div>

  <%# â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ %>
  <div class="flex-1 min-w-0">
    <p class="text-sm font-medium text-slate-800 truncate">
      <%= first_file ? first_file.filename.to_s : "Billete sin archivo" %>
    </p>

    <% case ticket.status %>
    <% when "pending_parse" %>
      <p class="text-xs text-slate-400 mt-0.5">Pendiente de anÃ¡lisis</p>

    <% when "processing" %>
      <p class="text-xs text-slate-500 mt-0.5 flex items-center gap-1.5">
        <%# Tailwind spin animation %>
        <svg class="w-3 h-3 animate-spin text-indigo-500" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
        </svg>
        Analizando con IA...
      </p>

    <% when "auto_verified" %>
      <p class="text-xs text-slate-500 mt-0.5">
        <% if ticket.flight_number.present? %>
          <span class="font-medium text-slate-700"><%= ticket.flight_number %></span> Â·
        <% end %>
        <%= ticket.departure_airport %> â†’ <%= ticket.arrival_airport %>
        <% if ticket.departure_datetime.present? %>
          Â· <%= ticket.departure_datetime.strftime("%d %b %Y") %>
        <% end %>
      </p>

    <% when "needs_review", "manual_required" %>
      <p class="text-xs text-amber-600 mt-0.5">
        <% if ticket.departure_airport.present? %>
          <%= ticket.departure_airport %> â†’ <%= ticket.arrival_airport %>
        <% else %>
          Datos incompletos â€” revisiÃ³n requerida
        <% end %>
      </p>

    <% when "error" %>
      <p class="text-xs text-red-500 mt-0.5">
        Error al analizar Â·
        <% if ticket.parsed_data&.dig("error").present? %>
          <span class="italic"><%= ticket.parsed_data["error"].truncate(60) %></span>
        <% end %>
      </p>

    <% else %>
      <p class="text-xs text-slate-400 mt-0.5">Subido <%= time_ago_in_words(ticket.created_at) %></p>
    <% end %>
  </div>

  <%# â”€â”€ Right-side badge / actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ %>
  <div class="flex items-center gap-2 flex-shrink-0">
    <% case ticket.status %>
    <% when "pending_parse" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                   bg-slate-100 text-slate-500">
        ğŸ“„ Pendiente
      </span>

    <% when "processing" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                   bg-indigo-100 text-indigo-600">
        Procesando...
      </span>

    <% when "auto_verified" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                   bg-emerald-100 text-emerald-700">
        âœ… Verificado
      </span>
      <%= link_to "Editar",
            verify_ticket_path(ticket),
            data: { turbo_frame: "modal" },
            class: "text-xs text-slate-400 hover:text-slate-600 underline transition-colors" %>

    <% when "needs_review", "manual_required" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                   bg-amber-100 text-amber-700">
        âš ï¸ Revisar
      </span>
      <%= link_to "Revisar ahora",
            verify_ticket_path(ticket),
            data: { turbo_frame: "modal" },
            class: "text-xs font-medium text-amber-700 hover:text-amber-900 underline transition-colors" %>

    <% when "error" %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                   bg-red-100 text-red-600">
        âŒ Error
      </span>

    <% else %>
      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                   bg-slate-100 text-slate-500">
        <%= ticket.status.humanize %>
      </span>
    <% end %>
  </div>

</div>
